//+------------------------------------------------------------------+
//|                                          15_storage_manager.mqh  |
//|                   –ú–æ–¥—É–ª—å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è FoxterAI v2.0      |
//|                         –ë–ï–ó GlobalVariables –∏ FILE_COMMON       |
//+------------------------------------------------------------------+

//--- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –ø—É—Ç–µ–π
#define STORAGE_ROOT_DIR     "FoxterAI"
#define SETTINGS_FILE        "settings.dat"
#define STATE_FILE          "state.dat"
#define LICENSE_FILE        "license.key"

//--- –§–ª–∞–≥–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
bool g_IsCleanShutdown = false;        // –§–ª–∞–≥ —á–∏—Å—Ç–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
datetime g_LastStateSave = 0;          // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
bool g_WasCrashRecovery = false;       // –§–ª–∞–≥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ—è
bool g_WasParametersChange = false;    // –ù–û–í–´–ô —Ñ–ª–∞–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ F7
string g_StorageAccountDir = "";       // –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ –∞–∫–∫–∞—É–Ω—Ç–∞
string g_StorageSymbolDir = "";        // –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å–∏–º–≤–æ–ª–∞
string g_StorageDir = "";              // –û–±—â–∏–π –ø—É—Ç—å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

//+------------------------------------------------------------------+
//| –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´ –•–†–ê–ù–ï–ù–ò–Ø                                  |
//+------------------------------------------------------------------+
void InitializeStorage() {
    if(IsTesting() || IsOptimization()) {
        Print("üìÅ –°–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è v2.0: —Ä–µ–∂–∏–º —Ç–µ—Å—Ç–µ—Ä–∞");
        return;
    }
    
    Print("========================================");
    Print("üìÅ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –õ–û–ö–ê–õ–¨–ù–û–ì–û –•–†–ê–ù–ò–õ–ò–©–ê v2.0");
    Print("========================================");
    
    g_StorageAccountDir = STORAGE_ROOT_DIR + "/" + IntegerToString(AccountNumber());
    g_StorageSymbolDir = g_StorageAccountDir + "/" + Symbol();
    g_StorageDir = g_StorageAccountDir;  // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    
    CreateDirectoryStructure();
    
    Print("üìÇ –ü–∞–ø–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞: ", g_StorageAccountDir);
    Print("üìÇ –ü–∞–ø–∫–∞ —Å–∏–º–≤–æ–ª–∞: ", g_StorageSymbolDir);
    
    CheckCrashRecovery();
    
    Print("========================================");
}

//+------------------------------------------------------------------+
//| –°–û–ó–î–ê–ù–ò–ï –°–¢–†–£–ö–¢–£–†–´ –î–ò–†–ï–ö–¢–û–†–ò–ô                                   |
//+------------------------------------------------------------------+
void CreateDirectoryStructure() {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é FolderCreate —Å –¥–≤—É–º—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    if(!FolderCreate(STORAGE_ROOT_DIR, FILE_COMMON)) {
        if(!FileIsExist(STORAGE_ROOT_DIR)) {
            Print("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É: ", STORAGE_ROOT_DIR);
        }
    }
    
    if(!FolderCreate(g_StorageAccountDir, FILE_COMMON)) {
        if(!FileIsExist(g_StorageAccountDir)) {
            Print("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –∞–∫–∫–∞—É–Ω—Ç–∞: ", g_StorageAccountDir);
        }
    }
    
    if(!FolderCreate(g_StorageSymbolDir, FILE_COMMON)) {
        if(!FileIsExist(g_StorageSymbolDir)) {
            Print("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É —Å–∏–º–≤–æ–ª–∞: ", g_StorageSymbolDir);
        }
    }
}

//+------------------------------------------------------------------+
//| –ü–†–û–í–ï–†–ö–ê –ù–ê –ê–í–ê–†–ò–ô–ù–û–ï –ó–ê–í–ï–†–®–ï–ù–ò–ï                               |
//+------------------------------------------------------------------+
void CheckCrashRecovery() {
    string stateFile = g_StorageSymbolDir + "/" + STATE_FILE;
    
    if(FileIsExist(stateFile)) {
        int handle = FileOpen(stateFile, FILE_READ | FILE_TXT);
        if(handle != INVALID_HANDLE) {
            string lastState = FileReadString(handle);
            FileClose(handle);
            
            // –ü–†–û–ë–õ–ï–ú–ê 5: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            if(StringFind(lastState, "PARAMETERS_CHANGE") >= 0) {
                g_WasParametersChange = true;
                Print("üìù –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ F7");
                // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–ª–µ—Ä—Ç –æ–± –∞–≤–∞—Ä–∏–π–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
                
                // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å —Ñ–ª–∞–≥–æ–º
                FileDelete(stateFile);
            }
            else if(StringFind(lastState, "CLEAN_SHUTDOWN") < 0) {
                g_WasCrashRecovery = true;
                Print("‚ö†Ô∏è –û–ë–ù–ê–†–£–ñ–ï–ù–û –ê–í–ê–†–ò–ô–ù–û–ï –ó–ê–í–ï–†–®–ï–ù–ò–ï!");
                Print("üìÅ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ—Å–ª–µ —Å–±–æ—è...");
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º —Å–±–æ–µ
                Alert("FoxterAI v2.0\n\n–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∞–≤–∞—Ä–∏–π–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ!\n–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.");
            }
        }
    }
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è
    SaveRobotState();
}

//+------------------------------------------------------------------+
//| –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–ª–∞–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤             |
//+------------------------------------------------------------------+
void SaveParametersChangeFlag() {
    if(IsTesting() || IsOptimization()) return;
    
    string stateFile = g_StorageSymbolDir + "/" + STATE_FILE;
    
    int handle = FileOpen(stateFile, FILE_WRITE | FILE_TXT);
    if(handle != INVALID_HANDLE) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥
        string state = "PARAMETERS_CHANGE=YES\n";
        state = state + "TIME=" + TimeToString(TimeCurrent()) + "\n";
        state = state + "SYMBOL=" + Symbol() + "\n";
        
        FileWriteString(handle, state);
        FileClose(handle);
        
        Print("üìù –°–æ—Ö—Ä–∞–Ω–µ–Ω —Ñ–ª–∞–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤");
    }
}

//+------------------------------------------------------------------+
//| –°–û–•–†–ê–ù–ò–¢–¨ –õ–ò–¶–ï–ù–ó–ò–û–ù–ù–´–ô –ö–õ–Æ–ß –õ–û–ö–ê–õ–¨–ù–û                           |
//+------------------------------------------------------------------+
void SaveLicenseKeyLocal(string key) {
    if(IsTesting() || IsOptimization()) return;
    
    string licenseFile = g_StorageAccountDir + "/" + LICENSE_FILE;
    
    int handle = FileOpen(licenseFile, FILE_WRITE | FILE_TXT);
    if(handle != INVALID_HANDLE) {
        FileWriteString(handle, key);
        FileClose(handle);
        Print("‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ");
    } else {
        Print("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏!");
    }
}

//+------------------------------------------------------------------+
//| –ü–û–õ–£–ß–ò–¢–¨ –õ–ò–¶–ï–ù–ó–ò–û–ù–ù–´–ô –ö–õ–Æ–ß –ò–ó –õ–û–ö–ê–õ–¨–ù–û–ì–û –•–†–ê–ù–ò–õ–ò–©–ê            |
//+------------------------------------------------------------------+
string GetLicenseKeyLocal() {
    if(IsTesting() || IsOptimization()) {
        return "UNIV-TEST-MODE-KEY";
    }
    
    string licenseFile = g_StorageAccountDir + "/" + LICENSE_FILE;
    
    if(!FileIsExist(licenseFile)) {
        Print("‚ùå –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –ª–∏—Ü–µ–Ω–∑–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return "";
    }
    
    int handle = FileOpen(licenseFile, FILE_READ | FILE_TXT);
    if(handle != INVALID_HANDLE) {
        string key = FileReadString(handle);
        FileClose(handle);
        
        string cleanKey = "";
        for(int i = 0; i < StringLen(key); i++) {
            ushort charCode = StringGetCharacter(key, i);
            if(charCode > 32 && charCode < 127) {
                cleanKey = cleanKey + CharToString((uchar)charCode);
            }
        }
        
        if(StringLen(cleanKey) >= 10 && StringSubstr(cleanKey, 0, 5) == "UNIV-") {
            Print("‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞");
            return cleanKey;
        }
    }
    
    return "";
}

//+------------------------------------------------------------------+
//| –£–î–ê–õ–ò–¢–¨ –õ–ò–¶–ï–ù–ó–ò–û–ù–ù–´–ô –ö–õ–Æ–ß                                      |
//+------------------------------------------------------------------+
void ClearLicenseKeyLocal() {
    string licenseFile = g_StorageAccountDir + "/" + LICENSE_FILE;
    if(FileIsExist(licenseFile)) {
        FileDelete(licenseFile);
    }
}

//+------------------------------------------------------------------+
//| –°–û–•–†–ê–ù–ò–¢–¨ –ù–ê–°–¢–†–û–ô–ö–ò –ü–ê–ù–ï–õ–ò                                     |
//+------------------------------------------------------------------+
void SavePanelSettings() {
    if(IsTesting() || IsOptimization()) {
        return;
    }
    
    string settingsFile = g_StorageSymbolDir + "/" + SETTINGS_FILE;
    
    int handle = FileOpen(settingsFile, FILE_WRITE | FILE_BIN);
    if(handle != INVALID_HANDLE) {
        FileWriteInteger(handle, 200); // –≤–µ—Ä—Å–∏—è 2.0.0
        
        FileWriteInteger(handle, g_BotEnabled ? 1 : 0);
        FileWriteInteger(handle, g_TradeDirection);
        FileWriteInteger(handle, g_MaxOrdersBuy);
        FileWriteInteger(handle, g_MaxOrdersSell);
        FileWriteDouble(handle, g_BasketProfitPercent);
        FileWriteInteger(handle, g_BasketType);
        FileWriteInteger(handle, g_BasketAfterN);
        
        FileWriteInteger(handle, g_PanelPosX);
        FileWriteInteger(handle, g_PanelPosY);
        
        // –ü–†–û–ë–õ–ï–ú–ê 3: –°–æ—Ö—Ä–∞–Ω—è–µ–º balanceAtStart –¥–ª—è —Å–µ—Ä–∏–π
        FileWriteDouble(handle, g_BuySeries.balanceAtStart);
        FileWriteDouble(handle, g_SellSeries.balanceAtStart);
        
        FileWriteLong(handle, TimeCurrent());
        
        FileClose(handle);
        Print("üíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è ", Symbol());
    }
}

//+------------------------------------------------------------------+
//| –ó–ê–ì–†–£–ó–ò–¢–¨ –ù–ê–°–¢–†–û–ô–ö–ò –ü–ê–ù–ï–õ–ò                                     |
//+------------------------------------------------------------------+
bool LoadPanelSettings() {
    if(IsTesting() || IsOptimization()) {
        Print("üìÅ –¢–µ—Å—Ç–µ—Ä: –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã");
        return false;
    }
    
    string settingsFile = g_StorageSymbolDir + "/" + SETTINGS_FILE;
    
    if(!FileIsExist(settingsFile)) {
        Print("üìÅ –§–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return false;
    }
    
    int handle = FileOpen(settingsFile, FILE_READ | FILE_BIN);
    if(handle != INVALID_HANDLE) {
        int version = FileReadInteger(handle);
        if(version != 200) {
            FileClose(handle);
            Print("‚ö†Ô∏è –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –≤–µ—Ä—Å–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: ", version);
            return false;
        }
        
        g_BotEnabled = FileReadInteger(handle) > 0;
        g_TradeDirection = (ENUM_TRADE_DIRECTION)FileReadInteger(handle);
        g_MaxOrdersBuy = FileReadInteger(handle);
        g_MaxOrdersSell = FileReadInteger(handle);
        g_BasketProfitPercent = FileReadDouble(handle);
        g_BasketType = (ENUM_BASKET_TYPE)FileReadInteger(handle);
        g_BasketAfterN = FileReadInteger(handle);
        
        g_PanelPosX = FileReadInteger(handle);
        g_PanelPosY = FileReadInteger(handle);
        
        // –ü–†–û–ë–õ–ï–ú–ê 3: –ó–∞–≥—Ä—É–∂–∞–µ–º balanceAtStart –¥–ª—è —Å–µ—Ä–∏–π
        g_BuySeries.balanceAtStart = FileReadDouble(handle);
        g_SellSeries.balanceAtStart = FileReadDouble(handle);
        
        datetime savedTime = (datetime)FileReadLong(handle);
        
        FileClose(handle);
        
        Print("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–ª—è ", Symbol());
        Print("   –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã: ", TimeToString(savedTime));
        Print("   –†–æ–±–æ—Ç: ", g_BotEnabled ? "–í–ö–õ–Æ–ß–ï–ù" : "–í–´–ö–õ–Æ–ß–ï–ù");
        
        return true;
    }
    
    return false;
}

//+------------------------------------------------------------------+
//| –°–û–•–†–ê–ù–ò–¢–¨ –°–û–°–¢–û–Ø–ù–ò–ï –†–û–ë–û–¢–ê                                     |
//+------------------------------------------------------------------+
void SaveRobotState() {
    if(IsTesting() || IsOptimization()) return;
    
    string stateFile = g_StorageSymbolDir + "/" + STATE_FILE;
    
    int handle = FileOpen(stateFile, FILE_WRITE | FILE_TXT);
    if(handle != INVALID_HANDLE) {
        string state = "";
        state = state + "VERSION=2.0.0\n";
        state = state + "TIME=" + TimeToString(TimeCurrent()) + "\n";
        state = state + "ACCOUNT=" + IntegerToString(AccountNumber()) + "\n";
        state = state + "SYMBOL=" + Symbol() + "\n";
        state = state + "MAGIC=" + IntegerToString(MagicNumber) + "\n";
        state = state + "BOT_ENABLED=" + (g_BotEnabled ? "YES" : "NO") + "\n";
        state = state + "CLEAN_SHUTDOWN=" + (g_IsCleanShutdown ? "YES" : "NO") + "\n";
        
        state = state + "BUY_SERIES_ACTIVE=" + (g_BuySeries.active ? "YES" : "NO") + "\n";
        state = state + "BUY_SERIES_COUNT=" + IntegerToString(g_BuySeries.count) + "\n";
        state = state + "BUY_BALANCE_AT_START=" + DoubleToString(g_BuySeries.balanceAtStart, 2) + "\n";
        
        state = state + "SELL_SERIES_ACTIVE=" + (g_SellSeries.active ? "YES" : "NO") + "\n";
        state = state + "SELL_SERIES_COUNT=" + IntegerToString(g_SellSeries.count) + "\n";
        state = state + "SELL_BALANCE_AT_START=" + DoubleToString(g_SellSeries.balanceAtStart, 2) + "\n";
        
        FileWriteString(handle, state);
        FileClose(handle);
        
        g_LastStateSave = TimeCurrent();
    }
}

//+------------------------------------------------------------------+
//| –ó–ê–ì–†–£–ó–ò–¢–¨ –°–û–°–¢–û–Ø–ù–ò–ï –†–û–ë–û–¢–ê                                     |
//+------------------------------------------------------------------+
bool LoadRobotState() {
    if(IsTesting() || IsOptimization()) return false;
    
    string stateFile = g_StorageSymbolDir + "/" + STATE_FILE;
    
    if(!FileIsExist(stateFile)) {
        return false;
    }
    
    int handle = FileOpen(stateFile, FILE_READ | FILE_TXT);
    if(handle != INVALID_HANDLE) {
        string content = "";
        while(!FileIsEnding(handle)) {
            content = content + FileReadString(handle) + "\n";
        }
        FileClose(handle);
        
        // –ü–†–û–ë–õ–ï–ú–ê 3: –ü–∞—Ä—Å–∏–º balanceAtStart –∏–∑ —Ñ–∞–π–ª–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        int buyBalancePos = StringFind(content, "BUY_BALANCE_AT_START=");
        if(buyBalancePos >= 0) {
            int endPos = StringFind(content, "\n", buyBalancePos);
            string valueStr = StringSubstr(content, buyBalancePos + 21, endPos - buyBalancePos - 21);
            g_BuySeries.balanceAtStart = StringToDouble(valueStr);
        }
        
        int sellBalancePos = StringFind(content, "SELL_BALANCE_AT_START=");
        if(sellBalancePos >= 0) {
            int endPos = StringFind(content, "\n", sellBalancePos);
            string valueStr = StringSubstr(content, sellBalancePos + 22, endPos - sellBalancePos - 22);
            g_SellSeries.balanceAtStart = StringToDouble(valueStr);
        }
        
        if(StringFind(content, "VERSION=2.0") >= 0) {
            Print("üìÅ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–æ–±–æ—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–æ");
            return true;
        }
    }
    
    return false;
}

//+------------------------------------------------------------------+
//| –ß–ò–°–¢–û–ï –ó–ê–ö–†–´–¢–ò–ï –†–û–ë–û–¢–ê                                         |
//+------------------------------------------------------------------+
void CleanShutdownRobot() {
    Print("========================================");
    Print("üî¥ –ß–ò–°–¢–û–ï –ó–ê–ö–†–´–¢–ò–ï –†–û–ë–û–¢–ê");
    Print("========================================");
    
    g_IsCleanShutdown = true;
    SaveRobotState();
    
    string settingsFile = g_StorageSymbolDir + "/" + SETTINGS_FILE;
    if(FileIsExist(settingsFile)) {
        FileDelete(settingsFile);
        Print("üóëÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è ", Symbol(), " —É–¥–∞–ª–µ–Ω—ã");
    }
    
    string stateFile = g_StorageSymbolDir + "/" + STATE_FILE;
    if(FileIsExist(stateFile)) {
        FileDelete(stateFile);
        Print("üóëÔ∏è –§–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–¥–∞–ª–µ–Ω");
    }
    
    Print("‚úÖ –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫ –±—É–¥–µ—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é");
    Print("========================================");
    
    if(g_BuySeries.active || g_SellSeries.active) {
        Print("‚ö†Ô∏è –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏...");
        CloseAllOrders();
    }
    
    DeletePanel();
    ExpertRemove();
}

//+------------------------------------------------------------------+
//| –ü–†–û–í–ï–†–ö–ê –°–£–©–ï–°–¢–í–û–í–ê–ù–ò–Ø –§–ê–ô–õ–ê –í –õ–û–ö–ê–õ–¨–ù–û–ô –ü–ê–ü–ö–ï                 |
//+------------------------------------------------------------------+
bool FileIsExistLocal(string filepath) {
    int handle = FileOpen(filepath, FILE_READ);
    if(handle != INVALID_HANDLE) {
        FileClose(handle);
        return true;
    }
    return false;
}

//+------------------------------------------------------------------+
//| –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø                             |
//+------------------------------------------------------------------+
void PeriodicStateSave() {
    if(IsTesting() || IsOptimization()) return;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    if(TimeCurrent() - g_LastStateSave > 300) {
        SaveRobotState();
        SavePanelSettings();
    }
}