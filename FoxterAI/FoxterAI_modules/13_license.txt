//+------------------------------------------------------------------+
//|                                                   13_license.mqh |
//|                     –ú–æ–¥—É–ª—å –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è FoxterAI v2.0     |
//|              –ü–û–õ–ù–ê–Ø –ü–ï–†–ï–î–ê–ß–ê –î–ê–ù–ù–´–• + 3 –î–ù–Ø –ê–í–¢–û–ù–û–ú–ù–û–ô –†–ê–ë–û–¢–´  |
//+------------------------------------------------------------------+

#import "wininet.dll"
    int InternetOpenW(string agent, int accessType, string proxyName, string proxyBypass, int flags);
    int InternetConnectW(int internet, string serverName, int port, string userName, string password, 
                        int service, int flags, int context);
    int HttpOpenRequestW(int connect, string verb, string objectName, string version, string referer, 
                        int &acceptTypes, int flags, int context);
    bool HttpSendRequestW(int request, string headers, int headersLength, uchar &buffer[], int bufferLength);
    int InternetReadFile(int request, uchar &buffer[], int bufferSize, int &bytesRead[]);
    int InternetCloseHandle(int handle);
#import

//--- –°–æ—Å—Ç–æ—è–Ω–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏
#define LICENSE_UNCHECKED 0     // –ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
#define LICENSE_VALID 1         // –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞
#define LICENSE_EXPIRED 2       // –ò—Å—Ç–µ–∫–ª–∞
#define LICENSE_INVALID 3       // –ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞
#define LICENSE_BLOCKED 4       // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
#define LICENSE_NO_CONNECTION 5 // –ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
#define LICENSE_GRACE_PERIOD 6  // –ì—Ä–µ–π—Å-–ø–µ—Ä–∏–æ–¥ (—Ä–∞–±–æ—Ç–∞ –±–µ–∑ —Å–≤—è–∑–∏)

//--- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–∏—Ü–µ–Ω–∑–∏–∏
int g_LicenseState = LICENSE_UNCHECKED;
string g_LicenseKey = "";
datetime g_LicenseExpiry = 0;
datetime g_LastSuccessfulCheck = 0;
datetime g_LastCheckAttempt = 0;
int g_FailedChecks = 0;
bool g_LicenseActivated = false;
string g_LicenseMessage = "";

//--- –ö–û–ù–°–¢–ê–ù–¢–´ –†–û–ë–û–¢–ê (—Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
#define ROBOT_NAME "FoxterAI"           // –†–µ–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–±–æ—Ç–∞
#define ROBOT_VERSION "1.6"              // –†–µ–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ä–æ–±–æ—Ç–∞

//--- –ñ–ï–°–¢–ö–û –ó–ê–®–ò–¢–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –°–ï–†–í–ï–†–ê
#define LICENSE_SERVER_URL "178.130.43.120"
#define LICENSE_SERVER_PORT 3000

//--- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Ñ–ª–∞–≥–æ–≤ WinInet (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –¥–ª—è MQL4)
#define INTERNET_FLAG_RELOAD            -2147483648  // 0x80000000 –∫–∞–∫ signed int
#define INTERNET_FLAG_NO_CACHE_WRITE    67108864     // 0x04000000
#define INTERNET_FLAG_PRAGMA_NOCACHE    256          // 0x00000100  
#define INTERNET_FLAG_NO_UI             512          // 0x00000200

//--- –ò–ó–ú–ï–ù–ï–ù–û: –£–ú–ï–ù–¨–®–ï–ù–´ –í–†–ï–ú–ï–ù–ù–´–ï –ò–ù–¢–ï–†–í–ê–õ–´
#define LICENSE_CHECK_INTERVAL 86400      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑ –≤ –°–£–¢–ö–ò (24 —á–∞—Å–∞)
#define LICENSE_HEARTBEAT_INTERVAL 43200  // Heartbeat —Ä–∞–∑ –≤ 12 –ß–ê–°–û–í
#define LICENSE_GRACE_PERIOD_HOURS 72     // 3 –î–ù–Ø —Ä–∞–±–æ—Ç—ã –±–µ–∑ —Å–≤—è–∑–∏ (–ò–ó–ú–ï–ù–ï–ù–û –° 10!)
#define MAX_FAILED_CHECKS 3               // 3 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∏ = 3 –¥–Ω—è (–ò–ó–ú–ï–ù–ï–ù–û –° 10!)
#define LICENSE_WARNING_DAYS 7            // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∑–∞ 7 –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è

//+------------------------------------------------------------------+
//| –ü–†–û–í–ï–†–ö–ê –ù–ê –¢–ï–°–¢–ï–†                                              |
//+------------------------------------------------------------------+
bool IsTestMode() {
    return (IsTesting() || IsOptimization() || IsVisualMode());
}

//+------------------------------------------------------------------+
//| –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –¢–ò–ü–ê –°–ß–ï–¢–ê (–î–ï–ú–û/–†–ï–ê–õ)                             |
//+------------------------------------------------------------------+
string GetAccountType() {
    if(IsTestMode()) return "Tester";
    
    // –°–ø–æ—Å–æ–± 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ IsDemo()
    if(IsDemo()) return "Demo";
    
    // –°–ø–æ—Å–æ–± 2: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞
    string broker = AccountCompany();
    string brokerLower = broker;
    StringToLower(brokerLower);
    
    if(StringFind(brokerLower, "demo") >= 0 || 
       StringFind(brokerLower, "contest") >= 0 ||
       StringFind(brokerLower, "virtual") >= 0) {
        return "Demo";
    }
    
    return "Real";
}

//+------------------------------------------------------------------+
//| –ë–ï–ó–û–ü–ê–°–ù–û–ï –ü–û–õ–£–ß–ï–ù–ò–ï –ò–ú–ï–ù–ò –í–õ–ê–î–ï–õ–¨–¶–ê –°–ß–ï–¢–ê - –ò–°–ü–†–ê–í–õ–ï–ù–û        |
//+------------------------------------------------------------------+
string GetAccountOwnerSafe() {
    if(IsTestMode()) return "Tester";
    
    string owner = AccountName();
    
    // –ï—Å–ª–∏ –∏–º—è –ø—É—Å—Ç–æ–µ –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–µ–ª—ã
    if(StringLen(owner) == 0 || StringTrimLeft(StringTrimRight(owner)) == "") {
        return "Account_" + IntegerToString(AccountNumber());
    }
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–∞–±–æ—Ä–æ–º Unicode-–∫–æ–¥–æ–≤
    if(StringFind(owner, "[") == 0 && StringFind(owner, "]") > 0) {
        // –≠—Ç–æ –∫–æ–¥—ã —Å–∏–º–≤–æ–ª–æ–≤ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–º–µ—Ä —Å—á–µ—Ç–∞
        // –£–ë–†–ê–ù–û: Print("–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã Unicode-–∫–æ–¥—ã –≤ –∏–º–µ–Ω–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–º–µ—Ä —Å—á–µ—Ç–∞");
        return "Account_" + IntegerToString(AccountNumber());
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ç–æ–ª—å–∫–æ ASCII —Å–∏–º–≤–æ–ª–æ–≤
    bool hasValidChars = false;
    string safeOwner = "";
    
    for(int i = 0; i < StringLen(owner) && i < 30; i++) {  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 30 —Å–∏–º–≤–æ–ª–∞–º–∏
        ushort charCode = StringGetCharacter(owner, i);
        
        // –ü—Ä–∏–Ω–∏–º–∞–µ–º —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        if((charCode >= 'A' && charCode <= 'Z') || 
           (charCode >= 'a' && charCode <= 'z') ||
           (charCode >= '0' && charCode <= '9') ||
           charCode == ' ' || charCode == '.' || charCode == '-' || charCode == '_') {
            safeOwner = safeOwner + CharToString((uchar)charCode);
            hasValidChars = true;
        }
        else if(charCode > 127) {
            // –ö–∏—Ä–∏–ª–ª–∏—Ü–∞ –∏–ª–∏ –¥—Ä—É–≥–∏–µ –Ω–µ-ASCII —Å–∏–º–≤–æ–ª—ã - –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ X
            safeOwner = safeOwner + "X";
            hasValidChars = true;
        }
    }
    
    // –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—É—á–∏–ª–∏ –≤–∞–ª–∏–¥–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    if(hasValidChars && StringLen(safeOwner) > 0) {
        string trimmed = StringTrimLeft(StringTrimRight(safeOwner));
        if(StringLen(trimmed) > 0) {
            return trimmed;
        }
    }
    
    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–º–µ—Ä —Å—á–µ—Ç–∞
    return "Account_" + IntegerToString(AccountNumber());
}

//+------------------------------------------------------------------+
//| –ü–û–õ–£–ß–ï–ù–ò–ï –û–¢–ü–ï–ß–ê–¢–ö–ê –°–ò–°–¢–ï–ú–´                                      |
//+------------------------------------------------------------------+
string GetSystemFingerprint() {
    if(IsTestMode()) {
        return "TESTER_MODE";
    }
    
    // –°–æ–∑–¥–∞–µ–º –æ—Ç–ø–µ—á–∞—Ç–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ: —Å—á–µ—Ç + —Ä–æ–±–æ—Ç + –≤–µ—Ä—Å–∏—è
    string fingerprint = "";
    fingerprint = fingerprint + IntegerToString(AccountNumber());
    fingerprint = fingerprint + "_" + ROBOT_NAME;
    fingerprint = fingerprint + "_" + ROBOT_VERSION;
    
    // –ü—Ä–æ—Å—Ç–æ–µ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
    int hash = 0;
    for(int i = 0; i < StringLen(fingerprint); i++) {
        hash = hash * 31 + StringGetCharacter(fingerprint, i);
    }
    
    return IntegerToString(MathAbs(hash));
}

//+------------------------------------------------------------------+
//| –û–¢–ü–†–ê–í–ö–ê HTTP –ó–ê–ü–†–û–°–ê –° –ü–û–õ–ù–û–ô –î–ò–ê–ì–ù–û–°–¢–ò–ö–û–ô                     |
//+------------------------------------------------------------------+
string SendHTTPRequest(string endpoint, string postData) {
    if(IsTestMode()) {
        return "{\"success\":true,\"message\":\"Test mode\"}";
    }
    
    // –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω—ã –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–≥–æ–≤
    // Print("===== –û–¢–ü–†–ê–í–ö–ê HTTP –ó–ê–ü–†–û–°–ê =====");
    // Print("URL: http://", LICENSE_SERVER_URL, ":", LICENSE_SERVER_PORT, endpoint);
    // Print("–î–∞–Ω–Ω—ã–µ: ", StringLen(postData) > 200 ? StringSubstr(postData, 0, 200) + "..." : postData);
    
    //--- –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    int hInternet = InternetOpenW("FoxterAI/1.6", 1, "", "", 0);
    if(hInternet == 0) {
        int error = GetLastError();
        // –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ
        // Print("‚ùå –û—à–∏–±–∫–∞ InternetOpen: ", error);
        
        hInternet = InternetOpenW("Mozilla/5.0", 0, "", "", 0);
        if(hInternet == 0) {
            // Print("‚ùå –ù–µ —É–¥–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ");
            return "";
        }
    }
    
    //--- –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
    int hConnect = InternetConnectW(hInternet, LICENSE_SERVER_URL, LICENSE_SERVER_PORT, 
                                   "", "", 3, 0, 0);
    if(hConnect == 0) {
        InternetCloseHandle(hInternet);
        // –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        // Print("‚ùå –ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –ª–∏—Ü–µ–Ω–∑–∏–π");
        return "";
    }
    
    //--- –°–æ–∑–¥–∞–µ–º HTTP –∑–∞–ø—Ä–æ—Å
    int flags = INTERNET_FLAG_RELOAD | INTERNET_FLAG_NO_CACHE_WRITE | 
                INTERNET_FLAG_PRAGMA_NOCACHE | INTERNET_FLAG_NO_UI;
    
    int acceptTypes = 0;
    int hRequest = HttpOpenRequestW(hConnect, "POST", endpoint, "HTTP/1.1", "", 
                                   acceptTypes, flags, 0);
    if(hRequest == 0) {
        InternetCloseHandle(hConnect);
        InternetCloseHandle(hInternet);
        return "";
    }
    
    //--- –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –º–∞—Å—Å–∏–≤ –±–∞–π—Ç
    uchar postDataArray[];
    int dataLen = StringLen(postData);
    ArrayResize(postDataArray, dataLen);
    StringToCharArray(postData, postDataArray, 0, dataLen);
    
    //--- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    string headers = "Content-Type: application/json\r\nConnection: close\r\n";
    
    if(!HttpSendRequestW(hRequest, headers, StringLen(headers), postDataArray, ArraySize(postDataArray))) {
        InternetCloseHandle(hRequest);
        InternetCloseHandle(hConnect);
        InternetCloseHandle(hInternet);
        return "";
    }
    
    //--- –ß–∏—Ç–∞–µ–º –æ—Ç–≤–µ—Ç
    uchar buffer[4096];
    int bytesRead[1];
    string response = "";
    int totalBytes = 0;
    
    while(true) {
        if(!InternetReadFile(hRequest, buffer, ArraySize(buffer) - 1, bytesRead)) {
            break;
        }
        
        if(bytesRead[0] <= 0) {
            break;
        }
        
        string chunk = CharArrayToString(buffer, 0, bytesRead[0]);
        response = response + chunk;
        totalBytes = totalBytes + bytesRead[0];
        
        if(totalBytes > 100000) {
            break;
        }
    }
    
    //--- –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ö—ç–Ω–¥–ª—ã
    InternetCloseHandle(hRequest);
    InternetCloseHandle(hConnect);
    InternetCloseHandle(hInternet);
    
    // –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω –≤—ã–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
    // Print("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ", StringLen(response) > 200 ? StringSubstr(response, 0, 200) + "..." : response);
    
    return response;
}

//+------------------------------------------------------------------+
//| –ê–ö–¢–ò–í–ê–¶–ò–Ø –õ–ò–¶–ï–ù–ó–ò–ò - –ü–û–õ–ù–ê–Ø –ü–ï–†–ï–î–ê–ß–ê –î–ê–ù–ù–´–•                    |
//+------------------------------------------------------------------+
bool ActivateLicense() {
    if(IsTestMode()) {
        g_LicenseState = LICENSE_VALID;
        g_LicenseActivated = true;
        g_LastSuccessfulCheck = TimeCurrent();
        g_LicenseMessage = "–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º - –ª–∏—Ü–µ–Ω–∑–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è";
        return true;
    }
    
    //--- –ù–û–í–û–ï: –°–æ–±–∏—Ä–∞–µ–º –í–°–ï –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
    string accountOwner = GetAccountOwnerSafe();
    string accountType = GetAccountType();
    double balance = AccountBalance();
    
    //--- –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    string postData = "{";
    postData = postData + "\"key\":\"" + g_LicenseKey + "\",";
    postData = postData + "\"account\":\"" + IntegerToString(AccountNumber()) + "\",";
    postData = postData + "\"account_owner\":\"" + accountOwner + "\",";  // –ù–û–í–û–ï
    postData = postData + "\"broker\":\"" + AccountCompany() + "\",";
    postData = postData + "\"robot_name\":\"" + ROBOT_NAME + "\",";       // –ù–û–í–û–ï: —Ä–µ–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
    postData = postData + "\"robot_version\":\"" + ROBOT_VERSION + "\","; // –ù–û–í–û–ï: —Ä–µ–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
    postData = postData + "\"balance\":" + DoubleToString(balance, 2) + ","; // –ù–û–í–û–ï
    postData = postData + "\"account_type\":\"" + accountType + "\",";    // –ù–û–í–û–ï
    postData = postData + "\"fingerprint\":\"" + GetSystemFingerprint() + "\"";
    postData = postData + "}";
    
    // –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω—ã –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–≥–æ–≤
    Print("=====================================");
    Print("       –ê–ö–¢–ò–í–ê–¶–ò–Ø –õ–ò–¶–ï–ù–ó–ò–ò");
    Print("=====================================");
    Print("–°—á–µ—Ç: ", AccountNumber());
    // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞, –±–∞–ª–∞–Ω—Å –∏ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    Print("=====================================");
    
    //--- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    string response = SendHTTPRequest("/activate", postData);
    
    if(response == "") {
        g_LicenseState = LICENSE_NO_CONNECTION;
        g_LicenseMessage = "–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ª–∏—Ü–µ–Ω–∑–∏–π";
        return false;
    }
    
    //--- –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
    if(StringFind(response, "\"success\":true") >= 0) {
        Print("‚úÖ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞");
        
        g_LicenseState = LICENSE_VALID;
        g_LicenseActivated = true;
        g_LastSuccessfulCheck = TimeCurrent();
        g_FailedChecks = 0;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ";
        
        GlobalVariableSet("FX_LastCheck_" + IntegerToString(AccountNumber()), TimeCurrent());
        
        return true;
    }
    else if(StringFind(response, "–Ω–µ –Ω–∞–π–¥–µ–Ω") >= 0 || StringFind(response, "not found") >= 0) {
        g_LicenseState = LICENSE_INVALID;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ";
        Print("‚ùå –ö–ª—é—á –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!");
        return false;
    }
    else if(StringFind(response, "—É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –¥—Ä—É–≥–æ–º —Å—á–µ—Ç–µ") >= 0 || 
            StringFind(response, "–ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É —Å—á–µ—Ç—É") >= 0 ||
            StringFind(response, "wrong_account") >= 0) {
        g_LicenseState = LICENSE_INVALID;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É —Å—á–µ—Ç—É";
        Print("‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É —Å—á–µ—Ç—É!");
        return false;
    }
    else if(StringFind(response, "–¥—Ä—É–≥–æ–º—É —Ä–æ–±–æ—Ç—É") >= 0 || StringFind(response, "wrong_robot") >= 0) {
        g_LicenseState = LICENSE_INVALID;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É —Ä–æ–±–æ—Ç—É";
        Print("‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É —Ä–æ–±–æ—Ç—É!");
        return false;
    }
    else if(StringFind(response, "–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞") >= 0 || StringFind(response, "blocked") >= 0) {
        g_LicenseState = LICENSE_BLOCKED;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞";
        return false;
    }
    else if(StringFind(response, "–∏—Å—Ç–µ–∫–ª–∞") >= 0 || StringFind(response, "expired") >= 0) {
        g_LicenseState = LICENSE_EXPIRED;
        g_LicenseMessage = "–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏ –∏—Å—Ç–µ–∫";
        return false;
    }
    
    g_LicenseState = LICENSE_INVALID;
    g_LicenseMessage = "–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏";
    return false;
}

//+------------------------------------------------------------------+
//| –ü–†–û–í–ï–†–ö–ê –õ–ò–¶–ï–ù–ó–ò–ò - –° –ü–ï–†–ï–î–ê–ß–ï–ô –†–û–ë–û–¢–ê                         |
//+------------------------------------------------------------------+
bool CheckLicense(bool isInitialCheck = false) {
    if(IsTestMode()) {
        if(g_LicenseState != LICENSE_VALID) {
            g_LicenseState = LICENSE_VALID;
            g_LicenseActivated = true;
            g_LicenseMessage = "–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º";
        }
        return true;
    }
    
    //--- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º
    if(isInitialCheck) {
        // –ò–ó–ú–ï–ù–ï–ù–û: –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        Print("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏...");
        
        bool result = ActivateLicense();
        g_LastCheckAttempt = TimeCurrent();
        return result;
    }
    
    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
    if(TimeCurrent() - g_LastCheckAttempt < LICENSE_CHECK_INTERVAL) {
        return (g_LicenseState == LICENSE_VALID);
    }
    
    g_LastCheckAttempt = TimeCurrent();
    
    // –ò–ó–ú–ï–ù–ï–ù–û: –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    Print("–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏...");
    
    //--- –ù–û–í–û–ï: –ü–µ—Ä–µ–¥–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–±–æ—Ç–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ
    string postData = "{";
    postData = postData + "\"key\":\"" + g_LicenseKey + "\",";
    postData = postData + "\"account\":\"" + IntegerToString(AccountNumber()) + "\",";
    postData = postData + "\"broker\":\"" + AccountCompany() + "\",";
    postData = postData + "\"robot_name\":\"" + ROBOT_NAME + "\",";       // –ù–û–í–û–ï
    postData = postData + "\"fingerprint\":\"" + GetSystemFingerprint() + "\"";
    postData = postData + "}";
    
    //--- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    string response = SendHTTPRequest("/check", postData);
    
    if(response == "") {
        g_FailedChecks++;
        Print("‚ö†Ô∏è –ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º, –ø–æ–ø—ã—Ç–æ–∫: ", g_FailedChecks, " –∏–∑ ", MAX_FAILED_CHECKS);
        
        // –ò–ó–ú–ï–ù–ï–ù–û: –î–∞–µ–º —Ç–æ–ª—å–∫–æ 3 –î–ù–Ø —Ä–∞–±–æ—Ç—ã –±–µ–∑ —Å–≤—è–∑–∏
        if(g_FailedChecks >= MAX_FAILED_CHECKS) {
            g_LicenseState = LICENSE_NO_CONNECTION;
            g_LicenseMessage = "–ü–æ—Ç–µ—Ä—è–Ω–∞ —Å–≤—è–∑—å —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ª–∏—Ü–µ–Ω–∑–∏–π –±–æ–ª–µ–µ 3 –¥–Ω–µ–π";
            Alert("–ö–†–ò–¢–ò–ß–ù–û: –ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ª–∏—Ü–µ–Ω–∑–∏–π –±–æ–ª–µ–µ 3 –¥–Ω–µ–π!\n–†–æ–±–æ—Ç –±—É–¥–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!");
            return false;
        }
        
        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        if(g_LicenseActivated) {
            if(g_FailedChecks == 1) {
                Print("–†–∞–±–æ—Ç–∞–µ–º –≤ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–º —Ä–µ–∂–∏–º–µ (–¥–µ–Ω—å 1 –∏–∑ 3)");
            } else if(g_FailedChecks == 2) {
                Alert("–í–ù–ò–ú–ê–ù–ò–ï: –ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º 2 –¥–Ω—è!\n–û—Å—Ç–∞–ª–æ—Å—å 1 –¥–µ–Ω—å –¥–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏!");
            }
        }
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ä–∞–±–æ—Ç—É
        return (g_LicenseState == LICENSE_VALID || g_LicenseActivated);
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π —Å–≤—è–∑–∏
    g_FailedChecks = 0;
    
    //--- –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
    if(StringFind(response, "\"success\":true") >= 0) {
        g_LicenseState = LICENSE_VALID;
        g_LastSuccessfulCheck = TimeCurrent();
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞";
        Print("‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞");
        return true;
    }
    else if(StringFind(response, "–Ω–µ –Ω–∞–π–¥–µ–Ω") >= 0 || StringFind(response, "not found") >= 0) {
        g_LicenseState = LICENSE_INVALID;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è —É–¥–∞–ª–µ–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞";
        Print("‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
        Alert("–õ–∏—Ü–µ–Ω–∑–∏—è —É–¥–∞–ª–µ–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞!\n–†–æ–±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.");
        return false;
    }
    else if(StringFind(response, "–∏—Å—Ç–µ–∫–ª–∞") >= 0 || StringFind(response, "expired") >= 0) {
        g_LicenseState = LICENSE_EXPIRED;
        g_LicenseMessage = "–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏ –∏—Å—Ç–µ–∫";
        Print("‚ö†Ô∏è –õ–∏—Ü–µ–Ω–∑–∏—è –∏—Å—Ç–µ–∫–ª–∞!");
        Alert("–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏ –∏—Å—Ç–µ–∫!\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∑–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º.");
        return false;
    }
    else if(StringFind(response, "–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞") >= 0 || StringFind(response, "blocked") >= 0) {
        g_LicenseState = LICENSE_BLOCKED;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º";
        Print("‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!");
        Alert("–õ–∏—Ü–µ–Ω–∑–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!");
        return false;
    }
    else if(StringFind(response, "–¥—Ä—É–≥–æ–º—É —Å—á–µ—Ç—É") >= 0 || StringFind(response, "wrong_account") >= 0) {
        g_LicenseState = LICENSE_INVALID;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É —Å—á–µ—Ç—É";
        Print("‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É —Å—á–µ—Ç—É!");
        return false;
    }
    else if(StringFind(response, "–¥—Ä—É–≥–æ–º—É —Ä–æ–±–æ—Ç—É") >= 0 || StringFind(response, "wrong_robot") >= 0) {
        g_LicenseState = LICENSE_INVALID;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É —Ä–æ–±–æ—Ç—É";
        Print("‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É —Ä–æ–±–æ—Ç—É!");
        return false;
    }
    
    g_LicenseState = LICENSE_INVALID;
    g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞";
    Print("‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞");
    return false;
}

//+------------------------------------------------------------------+
//| –û–¢–ü–†–ê–í–ö–ê HEARTBEAT - –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø                        |
//+------------------------------------------------------------------+
void SendHeartbeat() {
    if(IsTestMode()) return;
    
    static datetime lastHeartbeat = 0;
    
    if(TimeCurrent() - lastHeartbeat < LICENSE_HEARTBEAT_INTERVAL) return;
    
    if(g_LicenseState != LICENSE_VALID && !g_LicenseActivated) return;
    
    lastHeartbeat = TimeCurrent();
    
    // –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ heartbeat
    // Print("üíì –û—Ç–ø—Ä–∞–≤–∫–∞ heartbeat —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏...");
    
    //--- –ù–û–í–û–ï: –ü–µ—Ä–µ–¥–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    string accountType = GetAccountType();
    double balance = AccountBalance();
    double equity = AccountEquity();
    double profit = equity - balance;
    
    string postData = "{";
    postData = postData + "\"key\":\"" + g_LicenseKey + "\",";
    postData = postData + "\"account\":\"" + IntegerToString(AccountNumber()) + "\",";
    postData = postData + "\"broker\":\"" + AccountCompany() + "\",";
    postData = postData + "\"robot_name\":\"" + ROBOT_NAME + "\",";       // –ù–û–í–û–ï
    postData = postData + "\"version\":\"" + ROBOT_VERSION + "\",";       // –í–µ—Ä—Å–∏—è —Ä–æ–±–æ—Ç–∞
    postData = postData + "\"account_type\":\"" + accountType + "\",";    // –ù–û–í–û–ï: —Ç–∏–ø —Å—á–µ—Ç–∞
    postData = postData + "\"balance\":" + DoubleToString(balance, 2) + ",";
    postData = postData + "\"equity\":" + DoubleToString(equity, 2) + ","; // –ù–û–í–û–ï
    postData = postData + "\"profit\":" + DoubleToString(profit, 2);      // –ù–û–í–û–ï
    postData = postData + "}";
    
    SendHTTPRequest("/heartbeat", postData);
}

//+------------------------------------------------------------------+
//| –ü–†–û–í–ï–†–ö–ê –†–ê–ó–†–ï–®–ï–ù–ò–Ø –ù–ê –¢–û–†–ì–û–í–õ–Æ                                 |
//+------------------------------------------------------------------+
bool IsLicenseValidForTrading() {
    if(IsTestMode()) return true;
    
    // –ò–ó–ú–ï–ù–ï–ù–û: –†–∞–∑—Ä–µ—à–∞–µ–º —Ä–∞–±–æ—Ç—É –º–∞–∫—Å–∏–º—É–º 3 –¥–Ω—è –±–µ–∑ —Å–≤—è–∑–∏
    return (g_LicenseState == LICENSE_VALID || 
            (g_LicenseActivated && g_FailedChecks < MAX_FAILED_CHECKS));
}

//+------------------------------------------------------------------+
//| –ü–û–õ–£–ß–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –õ–ò–¶–ï–ù–ó–ò–ò –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø                     |
//+------------------------------------------------------------------+
string GetLicenseStatusText() {
    if(IsTestMode()) {
        return "–¢–ï–°–¢–ï–†";
    }
    
    if(g_LicenseState == LICENSE_VALID) {
        if(g_FailedChecks > 0) {
            return "–ê–≤—Ç–æ–Ω–æ–º " + IntegerToString(g_FailedChecks) + "/3–¥";
        }
        return "–ê–∫—Ç–∏–≤–Ω–∞";
    }
    else if(g_LicenseState == LICENSE_EXPIRED) {
        return "–ò—Å—Ç–µ–∫–ª–∞";
    }
    else if(g_LicenseState == LICENSE_INVALID) {
        return "–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç.";
    }
    else if(g_LicenseState == LICENSE_BLOCKED) {
        return "–ó–∞–±–ª–æ–∫–∏—Ä.";
    }
    else if(g_LicenseState == LICENSE_NO_CONNECTION) {
        return "–ù–µ—Ç —Å–≤—è–∑–∏";
    }
    else if(g_LicenseActivated && g_FailedChecks > 0) {
        return "–ê–≤—Ç–æ–Ω–æ–º " + IntegerToString(g_FailedChecks) + "/3–¥";
    }
    else {
        return "–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞";
    }
}

//+------------------------------------------------------------------+
//| –ü–û–õ–£–ß–ï–ù–ò–ï –¶–í–ï–¢–ê –°–¢–ê–¢–£–°–ê                                          |
//+------------------------------------------------------------------+
color GetLicenseStatusColor() {
    if(IsTestMode()) {
        return C'33,150,243';  // –°–∏–Ω–∏–π –¥–ª—è —Ç–µ—Å—Ç–µ—Ä–∞
    }
    
    if(g_LicenseState == LICENSE_VALID && g_FailedChecks == 0) {
        return C'76,175,80';  // –ó–µ–ª–µ–Ω—ã–π
    }
    else if(g_FailedChecks == 1) {
        return C'255,193,7';  // –ñ–µ–ª—Ç—ã–π - –¥–µ–Ω—å 1
    }
    else if(g_FailedChecks == 2) {
        return C'255,152,0';  // –û—Ä–∞–Ω–∂–µ–≤—ã–π - –¥–µ–Ω—å 2
    }
    else if(g_FailedChecks >= 3 || g_LicenseState == LICENSE_NO_CONNECTION) {
        return C'244,67,54';  // –ö—Ä–∞—Å–Ω—ã–π - –∫—Ä–∏—Ç–∏—á–Ω–æ
    }
    else {
        return C'244,67,54';  // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –≤—Å–µ—Ö –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö
    }
}

//+------------------------------------------------------------------+
//| –°–û–•–†–ê–ù–ò–¢–¨ –ö–õ–Æ–ß –í –§–ê–ô–õ - –í–°–ï–ì–î–ê –í FILE_COMMON                   |
//+------------------------------------------------------------------+
void SaveLicenseKeyToFile(string key) {
    if(IsTestMode()) return;
    
    string filename = "FoxterAI_" + IntegerToString(AccountNumber()) + ".key";
    
    // –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ–º FILE_COMMON –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –º–µ–∂–¥—É —Å–∏–º–≤–æ–ª–∞–º–∏
    int handle = FileOpen(filename, FILE_WRITE | FILE_TXT | FILE_COMMON);
    
    if(handle != INVALID_HANDLE) {
        FileWriteString(handle, key);
        FileClose(handle);
        // –ò–ó–ú–ï–ù–ï–ù–û: –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        Print("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
        
        // –î–û–ë–ê–í–õ–ï–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤
        GlobalVariableSet("FX_LICENSE_" + IntegerToString(AccountNumber()), StringGetCharacter(key, 0));
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª–∏–Ω—É –∫–ª—é—á–∞
        GlobalVariableSet("FX_LICENSE_LEN_" + IntegerToString(AccountNumber()), StringLen(key));
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ö—ç—à –∫–ª—é—á–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        int keyHash = 0;
        for(int i = 0; i < StringLen(key); i++) {
            keyHash = keyHash * 31 + StringGetCharacter(key, i);
        }
        GlobalVariableSet("FX_LICENSE_HASH_" + IntegerToString(AccountNumber()), MathAbs(keyHash));
        
    } else {
        // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
        handle = FileOpen(filename, FILE_WRITE | FILE_TXT);
        if(handle != INVALID_HANDLE) {
            FileWriteString(handle, key);
            FileClose(handle);
            // –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–∞–ø–∫–µ
            // Print("‚ö†Ô∏è –ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ø–∞–ø–∫—É MQL4/Files/");
        } else {
            Print("‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏!");
        }
    }
}

//+------------------------------------------------------------------+
//| –ü–û–õ–£–ß–ò–¢–¨ –°–û–•–†–ê–ù–ï–ù–ù–´–ô –ö–õ–Æ–ß - –° –ü–û–í–¢–û–†–ù–´–ú–ò –ü–û–ü–´–¢–ö–ê–ú–ò              |
//+------------------------------------------------------------------+
string GetSavedLicenseKey() {
    if(IsTestMode()) {
        return "UNIV-TEST-MODE-KEY";
    }
    
    // –î–û–ë–ê–í–õ–ï–ù–û: –ó–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≥–æ–Ω–∫–∏
    int symbolHash = 0;
    for(int i = 0; i < StringLen(Symbol()); i++) {
        symbolHash += StringGetCharacter(Symbol(), i);
    }
    Sleep((symbolHash % 10) * 100); // –ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç 0 –¥–æ 900–º—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∏–º–≤–æ–ª–∞
    
    string filename = "FoxterAI_" + IntegerToString(AccountNumber()) + ".key";
    string cleanKey = "";
    
    // –î–û–ë–ê–í–õ–ï–ù–û: –ü–æ–ø—ã—Ç–∫–∏ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏
    for(int attempt = 0; attempt < 3; attempt++) {
        // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ FILE_COMMON
        int handle = FileOpen(filename, FILE_READ | FILE_TXT | FILE_COMMON);
        
        if(handle != INVALID_HANDLE) {
            string key = FileReadString(handle);
            FileClose(handle);
            
            // –û—á–∏—â–∞–µ–º –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –Ω–µ–≤–∏–¥–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
            cleanKey = "";
            for(int i = 0; i < StringLen(key); i++) {
                ushort charCode = StringGetCharacter(key, i);
                if(charCode > 32 && charCode < 127) {
                    cleanKey = cleanKey + CharToString((uchar)charCode);
                }
            }
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ UNIV –∫–ª—é—á–∏
            if(StringLen(cleanKey) >= 10 && StringSubstr(cleanKey, 0, 5) == "UNIV-") {
                // –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª—é—á–æ–º
                // Print("‚úÖ UNIV –∫–ª—é—á –Ω–∞–π–¥–µ–Ω –≤ –æ–±—â–µ–π –ø–∞–ø–∫–µ (–ø–æ–ø—ã—Ç–∫–∞ ", attempt + 1, "): ", cleanKey);
                return cleanKey;
            }
        }
        
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ FILE_COMMON, –ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø–∞–ø–∫—É
        handle = FileOpen(filename, FILE_READ | FILE_TXT);
        
        if(handle != INVALID_HANDLE) {
            string key = FileReadString(handle);
            FileClose(handle);
            
            cleanKey = "";
            for(int i = 0; i < StringLen(key); i++) {
                ushort charCode = StringGetCharacter(key, i);
                if(charCode > 32 && charCode < 127) {
                    cleanKey = cleanKey + CharToString((uchar)charCode);
                }
            }
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ UNIV –∫–ª—é—á–∏
            if(StringLen(cleanKey) >= 10 && StringSubstr(cleanKey, 0, 5) == "UNIV-") {
                // –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏
                // Print("‚ö†Ô∏è UNIV –∫–ª—é—á –Ω–∞–π–¥–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–∞–ø–∫–µ, –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ –æ–±—â—É—é...");
                SaveLicenseKeyToFile(cleanKey);
                return cleanKey;
            }
        }
        
        // –î–û–ë–ê–í–õ–ï–ù–û: –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        if(attempt == 1) {
            if(GlobalVariableCheck("FX_LICENSE_HASH_" + IntegerToString(AccountNumber()))) {
                // –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                // Print("‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–ª—é—á –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö...");
                
                // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ - –≤–æ–∑–º–æ–∂–Ω–æ –¥—Ä—É–≥–æ–π —Ä–æ–±–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–ª—é—á
                Sleep(500);
                
                // –°–º–æ—Ç—Ä–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ö—ç—à
                double savedHash = GlobalVariableGet("FX_LICENSE_HASH_" + IntegerToString(AccountNumber()));
                double savedLen = GlobalVariableGet("FX_LICENSE_LEN_" + IntegerToString(AccountNumber()));
                
                // –ï—Å–ª–∏ —Ö—ç—à –µ—Å—Ç—å, –∑–Ω–∞—á–∏—Ç –∫–ª—é—á –±—ã–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω
                if(savedHash > 0 && savedLen > 0) {
                    // –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                    // Print("üîç –ù–∞–π–¥–µ–Ω —Ö—ç—à –∫–ª—é—á–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö. –î–ª–∏–Ω–∞ –∫–ª—é—á–∞: ", (int)savedLen);
                    // Print("‚ö†Ô∏è –ö–ª—é—á –±—ã–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω —Ä–∞–Ω–µ–µ, –Ω–æ —Ñ–∞–π–ª –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
                    
                    // –ñ–¥–µ–º –µ—â–µ –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑
                    Sleep(1000);
                    continue; // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–µ
                }
            }
        }
        
        // –ñ–¥–µ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
        if(attempt < 2) {
            // –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            // Print("‚è≥ –ü–æ–ø—ã—Ç–∫–∞ ", attempt + 1, " –Ω–µ —É–¥–∞–ª–∞—Å—å, –∂–¥–µ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π...");
            Sleep(500 * (attempt + 1)); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É —Å –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
        }
    }
    
    // –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–ª—é—á–∞
    // Print("‚ùå –õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫");
    return "";
}

//+------------------------------------------------------------------+
//| –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –õ–ò–¶–ï–ù–ó–ò–ò                                           |
//+------------------------------------------------------------------+
bool InitializeLicense(string licenseKey) {
    if(IsTestMode()) {
        g_LicenseKey = "UNIV-TEST-MODE-KEY";
        g_LicenseState = LICENSE_VALID;
        g_LicenseActivated = true;
        g_LicenseMessage = "–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º - –ª–∏—Ü–µ–Ω–∑–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è";
        
        Print("=====================================");
        Print("    –†–ï–ñ–ò–ú –¢–ï–°–¢–ï–†–ê –°–¢–†–ê–¢–ï–ì–ò–ô");
        Print("=====================================");
        Print("–õ–∏—Ü–µ–Ω–∑–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞");
        Print("=====================================");
        
        return true;
    }
    
    g_LicenseKey = licenseKey;
    
    // –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω—ã –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    Print("=====================================");
    Print("    –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´");
    Print("=====================================");
    Print("–°—á–µ—Ç: ", AccountNumber());
    // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª—é—á, –≤–ª–∞–¥–µ–ª—å—Ü–∞, –±—Ä–æ–∫–µ—Ä–∞ –∏ –ø—Ä–æ—á–µ–µ
    Print("=====================================");
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    g_LicenseState = LICENSE_UNCHECKED;
    g_LicenseActivated = false;
    g_LastSuccessfulCheck = 0;
    g_FailedChecks = 0;
    
    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    bool result = CheckLicense(true);
    
    Print("=====================================");
    Print("–†–µ–∑—É–ª—å—Ç–∞—Ç: ", result ? "–£–°–ü–ï–•" : "–û–®–ò–ë–ö–ê");
    if(!result) {
        Print("–ü—Ä–∏—á–∏–Ω–∞: ", g_LicenseMessage);
    } else {
        Print("–°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞");
        // –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ heartbeat
        Print("–ê–≤—Ç–æ–Ω–æ–º–Ω–∞—è —Ä–∞–±–æ—Ç–∞: –º–∞–∫—Å–∏–º—É–º 3 –¥–Ω—è");
    }
    Print("=====================================");
    
    return result;
}

//+------------------------------------------------------------------+
//| –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –î–ê–ù–ù–´–• –õ–ò–¶–ï–ù–ó–ò–ò                                  |
//+------------------------------------------------------------------+
void ClearAllLicenseData() {
    if(IsTestMode()) return;
    
    string filename = "FoxterAI_" + IntegerToString(AccountNumber()) + ".key";
    
    // –£–¥–∞–ª—è–µ–º –∏–∑ –æ–±–µ–∏—Ö –ª–æ–∫–∞—Ü–∏–π
    FileDelete(filename, FILE_COMMON);
    FileDelete(filename);
    
    // –£–¥–∞–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    GlobalVariableDel("FX_LastCheck_" + IntegerToString(AccountNumber()));
    GlobalVariableDel("FX_LICENSE_" + IntegerToString(AccountNumber()));
    GlobalVariableDel("FX_LICENSE_LEN_" + IntegerToString(AccountNumber()));
    GlobalVariableDel("FX_LICENSE_HASH_" + IntegerToString(AccountNumber()));
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏
    g_LicenseState = LICENSE_UNCHECKED;
    g_LicenseKey = "";
    g_LicenseExpiry = 0;
    g_LastSuccessfulCheck = 0;
    g_LastCheckAttempt = 0;
    g_FailedChecks = 0;
    g_LicenseActivated = false;
    g_LicenseMessage = "";
    
    // –ò–ó–ú–ï–ù–ï–ù–û: –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    Print("‚úÖ –î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã");
}