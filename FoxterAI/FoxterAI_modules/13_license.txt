//+------------------------------------------------------------------+
//|                                                   13_license.mqh |
//|                     –ú–æ–¥—É–ª—å –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è FoxterAI v1.6     |
//|                      –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –ë–ï–ó –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ô        |
//+------------------------------------------------------------------+

#import "wininet.dll"
    int InternetOpenW(string agent, int accessType, string proxyName, string proxyBypass, int flags);
    int InternetConnectW(int internet, string serverName, int port, string userName, string password, 
                        int service, int flags, int context);
    int HttpOpenRequestW(int connect, string verb, string objectName, string version, string referer, 
                        int &acceptTypes, int flags, int context);
    bool HttpSendRequestW(int request, string headers, int headersLength, uchar &buffer[], int bufferLength);
    int InternetReadFile(int request, uchar &buffer[], int bufferSize, int &bytesRead[]);
    int InternetCloseHandle(int handle);
#import

//--- –°–æ—Å—Ç–æ—è–Ω–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏
#define LICENSE_UNCHECKED 0     // –ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
#define LICENSE_VALID 1         // –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞
#define LICENSE_EXPIRED 2       // –ò—Å—Ç–µ–∫–ª–∞
#define LICENSE_INVALID 3       // –ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞
#define LICENSE_BLOCKED 4       // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
#define LICENSE_NO_CONNECTION 5 // –ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
#define LICENSE_GRACE_PERIOD 6  // –ì—Ä–µ–π—Å-–ø–µ—Ä–∏–æ–¥ (—Ä–∞–±–æ—Ç–∞ –±–µ–∑ —Å–≤—è–∑–∏)

//--- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–∏—Ü–µ–Ω–∑–∏–∏
int g_LicenseState = LICENSE_UNCHECKED;
string g_LicenseKey = "";
datetime g_LicenseExpiry = 0;
datetime g_LastSuccessfulCheck = 0;
datetime g_LastCheckAttempt = 0;
int g_FailedChecks = 0;
bool g_LicenseActivated = false;
string g_LicenseMessage = "";

//--- –ñ–ï–°–¢–ö–û –ó–ê–®–ò–¢–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –°–ï–†–í–ï–†–ê
#define LICENSE_SERVER_URL "178.130.43.120"
#define LICENSE_SERVER_PORT 3000

//--- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Ñ–ª–∞–≥–æ–≤ WinInet (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –¥–ª—è MQL4)
#define INTERNET_FLAG_RELOAD            -2147483648  // 0x80000000 –∫–∞–∫ signed int
#define INTERNET_FLAG_NO_CACHE_WRITE    67108864     // 0x04000000
#define INTERNET_FLAG_PRAGMA_NOCACHE    256          // 0x00000100  
#define INTERNET_FLAG_NO_UI             512          // 0x00000200

//--- –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤—Ä–µ–º–µ–Ω–∏
#define LICENSE_CHECK_INTERVAL 86400      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑ –≤ –°–£–¢–ö–ò (24 —á–∞—Å–∞)
#define LICENSE_HEARTBEAT_INTERVAL 43200  // Heartbeat —Ä–∞–∑ –≤ 12 –ß–ê–°–û–í
#define LICENSE_GRACE_PERIOD_HOURS 72     // 3 –î–ù–Ø —Ä–∞–±–æ—Ç—ã –±–µ–∑ —Å–≤—è–∑–∏
#define MAX_FAILED_CHECKS 10              // 10 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ (—ç—Ç–æ 10 –¥–Ω–µ–π!)
#define LICENSE_WARNING_DAYS 7            // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∑–∞ 7 –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è

//+------------------------------------------------------------------+
//| –ü–†–û–í–ï–†–ö–ê –ù–ê –¢–ï–°–¢–ï–†                                              |
//+------------------------------------------------------------------+
bool IsTestMode() {
    return (IsTesting() || IsOptimization() || IsVisualMode());
}

//+------------------------------------------------------------------+
//| –ü–û–õ–£–ß–ï–ù–ò–ï –û–¢–ü–ï–ß–ê–¢–ö–ê –°–ò–°–¢–ï–ú–´                                      |
//+------------------------------------------------------------------+
string GetSystemFingerprint() {
    //--- –í —Ç–µ—Å—Ç–µ—Ä–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–ø–µ—á–∞—Ç–æ–∫
    if(IsTestMode()) {
        return "TESTER_MODE";
    }
    
    //--- –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –æ—Ç–ø–µ—á–∞—Ç–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º—ã
    string fingerprint = "";
    fingerprint = fingerprint + IntegerToString(AccountNumber());
    fingerprint = fingerprint + "_" + AccountCompany();
    fingerprint = fingerprint + "_MT4_v1.6";
    
    //--- –ü—Ä–æ—Å—Ç–æ–µ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
    int hash = 0;
    for(int i = 0; i < StringLen(fingerprint); i++) {
        hash = hash * 31 + StringGetCharacter(fingerprint, i);
    }
    
    return IntegerToString(MathAbs(hash));
}

//+------------------------------------------------------------------+
//| –û–¢–ü–†–ê–í–ö–ê HTTP –ó–ê–ü–†–û–°–ê –° –ü–û–õ–ù–û–ô –î–ò–ê–ì–ù–û–°–¢–ò–ö–û–ô                     |
//+------------------------------------------------------------------+
string SendHTTPRequest(string endpoint, string postData) {
    //--- –í –¢–ï–°–¢–ï–†–ï –ù–ï –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ó–ê–ü–†–û–°–´!
    if(IsTestMode()) {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è —Ç–µ—Å—Ç–µ—Ä–∞
        return "{\"success\":true,\"message\":\"Test mode\"}";
    }
    
    string result = "";
    
    Print("===== –û–¢–ü–†–ê–í–ö–ê HTTP –ó–ê–ü–†–û–°–ê =====");
    Print("URL: http://", LICENSE_SERVER_URL, ":", LICENSE_SERVER_PORT, endpoint);
    Print("–î–∞–Ω–Ω—ã–µ: ", postData);
    
    //--- –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    int hInternet = InternetOpenW("FoxterAI/1.6", 1, "", "", 0);
    if(hInternet == 0) {
        int error = GetLastError();
        Print("‚ùå –û—à–∏–±–∫–∞ InternetOpen: ", error);
        
        // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π User-Agent
        hInternet = InternetOpenW("Mozilla/5.0", 0, "", "", 0);
        if(hInternet == 0) {
            Print("‚ùå –ù–µ —É–¥–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ");
            return "";
        }
    }
    
    //--- –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
    int hConnect = InternetConnectW(hInternet, LICENSE_SERVER_URL, LICENSE_SERVER_PORT, 
                                   "", "", 3, 0, 0); // 3 = INTERNET_SERVICE_HTTP
    if(hConnect == 0) {
        InternetCloseHandle(hInternet);
        Print("‚ùå –ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –ª–∏—Ü–µ–Ω–∑–∏–π");
        return "";
    }
    
    //--- –°–æ–∑–¥–∞–µ–º HTTP –∑–∞–ø—Ä–æ—Å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ñ–ª–∞–≥–∞–º–∏
    int flags = INTERNET_FLAG_RELOAD | INTERNET_FLAG_NO_CACHE_WRITE | 
                INTERNET_FLAG_PRAGMA_NOCACHE | INTERNET_FLAG_NO_UI;
    
    int acceptTypes = 0;
    int hRequest = HttpOpenRequestW(hConnect, "POST", endpoint, "HTTP/1.1", "", 
                                   acceptTypes, flags, 0);
    if(hRequest == 0) {
        InternetCloseHandle(hConnect);
        InternetCloseHandle(hInternet);
        return "";
    }
    
    //--- –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –º–∞—Å—Å–∏–≤ –±–∞–π—Ç
    uchar postDataArray[];
    int dataLen = StringLen(postData);
    ArrayResize(postDataArray, dataLen);
    StringToCharArray(postData, postDataArray, 0, dataLen);
    
    //--- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
    string headers = "Content-Type: application/json\r\nConnection: close\r\n";
    
    if(!HttpSendRequestW(hRequest, headers, StringLen(headers), postDataArray, ArraySize(postDataArray))) {
        InternetCloseHandle(hRequest);
        InternetCloseHandle(hConnect);
        InternetCloseHandle(hInternet);
        return "";
    }
    
    //--- –ß–∏—Ç–∞–µ–º –æ—Ç–≤–µ—Ç
    uchar buffer[4096];
    int bytesRead[1];
    string response = "";
    int totalBytes = 0;
    
    while(true) {
        if(!InternetReadFile(hRequest, buffer, ArraySize(buffer) - 1, bytesRead)) {
            break;
        }
        
        if(bytesRead[0] <= 0) {
            break;
        }
        
        string chunk = CharArrayToString(buffer, 0, bytesRead[0]);
        response = response + chunk;
        totalBytes = totalBytes + bytesRead[0];
        
        if(totalBytes > 100000) {
            break;
        }
    }
    
    //--- –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ö—ç–Ω–¥–ª—ã
    InternetCloseHandle(hRequest);
    InternetCloseHandle(hConnect);
    InternetCloseHandle(hInternet);
    
    Print("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ", StringLen(response) > 200 ? StringSubstr(response, 0, 200) + "..." : response);
    
    return response;
}

//+------------------------------------------------------------------+
//| –ê–ö–¢–ò–í–ê–¶–ò–Ø –õ–ò–¶–ï–ù–ó–ò–ò - –ü–†–Ø–ú–ê–Ø –ü–†–û–í–ï–†–ö–ê –ù–ê –°–ï–†–í–ï–†–ï                |
//+------------------------------------------------------------------+
bool ActivateLicense() {
    //--- –í –¢–ï–°–¢–ï–†–ï –í–°–ï–ì–î–ê –í–ê–õ–ò–î–ù–ê
    if(IsTestMode()) {
        g_LicenseState = LICENSE_VALID;
        g_LicenseActivated = true;
        g_LastSuccessfulCheck = TimeCurrent();
        g_LicenseMessage = "–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º - –ª–∏—Ü–µ–Ω–∑–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è";
        return true;
    }
    
    //--- –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    string postData = "{";
    postData = postData + "\"key\":\"" + g_LicenseKey + "\",";
    postData = postData + "\"account\":\"" + IntegerToString(AccountNumber()) + "\",";
    postData = postData + "\"broker\":\"" + AccountCompany() + "\",";
    postData = postData + "\"fingerprint\":\"" + GetSystemFingerprint() + "\"";
    postData = postData + "}";
    
    Print("=====================================");
    Print("       –ê–ö–¢–ò–í–ê–¶–ò–Ø –õ–ò–¶–ï–ù–ó–ò–ò");
    Print("=====================================");
    
    //--- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    string response = SendHTTPRequest("/activate", postData);
    
    if(response == "") {
        g_LicenseState = LICENSE_NO_CONNECTION;
        g_LicenseMessage = "–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ª–∏—Ü–µ–Ω–∑–∏–π";
        return false;
    }
    
    //--- –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç (–ø—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ JSON)
    if(StringFind(response, "\"success\":true") >= 0) {
        Print("‚úÖ –°–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∞–∫—Ç–∏–≤–∞—Ü–∏—é");
        
        g_LicenseState = LICENSE_VALID;
        g_LicenseActivated = true;
        g_LastSuccessfulCheck = TimeCurrent();
        g_FailedChecks = 0;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ";
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∏–Ω–∏–º—É–º –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        GlobalVariableSet("FX_LastCheck_" + IntegerToString(AccountNumber()), TimeCurrent());
        
        return true;
    }
    else if(StringFind(response, "–Ω–µ –Ω–∞–π–¥–µ–Ω") >= 0 || StringFind(response, "not found") >= 0) {
        g_LicenseState = LICENSE_INVALID;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ";
        Print("‚ùå –ö–ª—é—á –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!");
        return false;
    }
    else if(StringFind(response, "—É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –¥—Ä—É–≥–æ–º —Å—á–µ—Ç–µ") >= 0 || 
            StringFind(response, "–ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É —Å—á–µ—Ç—É") >= 0 ||
            StringFind(response, "wrong_account") >= 0) {
        g_LicenseState = LICENSE_INVALID;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É —Å—á–µ—Ç—É";
        Print("‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É —Å—á–µ—Ç—É!");
        return false;
    }
    else if(StringFind(response, "–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞") >= 0 || StringFind(response, "blocked") >= 0) {
        g_LicenseState = LICENSE_BLOCKED;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞";
        return false;
    }
    else if(StringFind(response, "–∏—Å—Ç–µ–∫–ª–∞") >= 0 || StringFind(response, "expired") >= 0) {
        g_LicenseState = LICENSE_EXPIRED;
        g_LicenseMessage = "–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏ –∏—Å—Ç–µ–∫";
        return false;
    }
    
    g_LicenseState = LICENSE_INVALID;
    g_LicenseMessage = "–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏";
    return false;
}

//+------------------------------------------------------------------+
//| –ü–†–û–í–ï–†–ö–ê –õ–ò–¶–ï–ù–ó–ò–ò - –í–°–ï–ì–î–ê –ù–ê –°–ï–†–í–ï–†–ï                           |
//+------------------------------------------------------------------+
bool CheckLicense(bool isInitialCheck = false) {
    //--- –í –¢–ï–°–¢–ï–†–ï –í–°–ï–ì–î–ê –í–ê–õ–ò–î–ù–ê
    if(IsTestMode()) {
        if(g_LicenseState != LICENSE_VALID) {
            g_LicenseState = LICENSE_VALID;
            g_LicenseActivated = true;
            g_LicenseMessage = "–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º";
        }
        return true;
    }
    
    //--- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º
    if(isInitialCheck) {
        Print("üîç –ü–µ—Ä–≤–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏...");
        
        // –í—Å–µ–≥–¥–∞ –ø—ã—Ç–∞–µ–º—Å—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
        bool result = ActivateLicense();
        g_LastCheckAttempt = TimeCurrent();
        return result;
    }
    
    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ (–†–ê–ó –í –°–£–¢–ö–ò!)
    if(TimeCurrent() - g_LastCheckAttempt < LICENSE_CHECK_INTERVAL) {
        // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —Å—á–∏—Ç–∞–µ–º –≤–∞–ª–∏–¥–Ω–æ–π
        return (g_LicenseState == LICENSE_VALID);
    }
    
    g_LastCheckAttempt = TimeCurrent();
    
    Print("üì° –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...");
    
    //--- –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    string postData = "{";
    postData = postData + "\"key\":\"" + g_LicenseKey + "\",";
    postData = postData + "\"account\":\"" + IntegerToString(AccountNumber()) + "\",";
    postData = postData + "\"broker\":\"" + AccountCompany() + "\",";
    postData = postData + "\"fingerprint\":\"" + GetSystemFingerprint() + "\"";
    postData = postData + "}";
    
    //--- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    string response = SendHTTPRequest("/check", postData);
    
    if(response == "") {
        g_FailedChecks++;
        Print("‚ö†Ô∏è –ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º, –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫: ", g_FailedChecks, " –∏–∑ ", MAX_FAILED_CHECKS);
        
        // –î–∞–µ–º 3 –î–ù–Ø —Ä–∞–±–æ—Ç—ã –±–µ–∑ —Å–≤—è–∑–∏
        if(g_FailedChecks >= MAX_FAILED_CHECKS) {
            g_LicenseState = LICENSE_NO_CONNECTION;
            g_LicenseMessage = "–ü–æ—Ç–µ—Ä—è–Ω–∞ —Å–≤—è–∑—å —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ª–∏—Ü–µ–Ω–∑–∏–π –±–æ–ª–µ–µ 10 –¥–Ω–µ–π";
            Alert("–ö–†–ò–¢–ò–ß–ù–û: –ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ª–∏—Ü–µ–Ω–∑–∏–π –±–æ–ª–µ–µ 10 –¥–Ω–µ–π!\n–†–æ–±–æ—Ç –±—É–¥–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!");
            return false;
        }
        
        // –ï—Å–ª–∏ —É –Ω–∞—Å –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É
        if(g_LicenseActivated && g_FailedChecks < 5) {
            // –ü–µ—Ä–≤—ã–µ 5 –¥–Ω–µ–π –ø—Ä–æ—Å—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º
            Print("‚ÑπÔ∏è –†–∞–±–æ—Ç–∞–µ–º –≤ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–º —Ä–µ–∂–∏–º–µ (–¥–µ–Ω—å ", g_FailedChecks, ")");
        } else if(g_FailedChecks >= 5) {
            // –ü–æ—Å–ª–µ 5 –¥–Ω–µ–π –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—Ç—å
            Alert("–í–ù–ò–ú–ê–ù–ò–ï: –ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º ", g_FailedChecks, " –¥–Ω–µ–π!\n",
                  "–û—Å—Ç–∞–ª–æ—Å—å ", MAX_FAILED_CHECKS - g_FailedChecks, " –¥–Ω–µ–π –¥–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.");
        }
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ä–∞–±–æ—Ç—É
        return (g_LicenseState == LICENSE_VALID || g_LicenseActivated);
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π —Å–≤—è–∑–∏
    g_FailedChecks = 0;
    
    //--- –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
    if(StringFind(response, "\"success\":true") >= 0) {
        g_LicenseState = LICENSE_VALID;
        g_LastSuccessfulCheck = TimeCurrent();
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞";
        Print("‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ (–µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞)");
        return true;
    }
    else if(StringFind(response, "–Ω–µ –Ω–∞–π–¥–µ–Ω") >= 0 || StringFind(response, "not found") >= 0) {
        g_LicenseState = LICENSE_INVALID;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è —É–¥–∞–ª–µ–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞";
        Print("‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (—É–¥–∞–ª–µ–Ω–∞)!");
        Alert("–õ–∏—Ü–µ–Ω–∑–∏—è —É–¥–∞–ª–µ–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞!\n–†–æ–±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.");
        return false;
    }
    else if(StringFind(response, "–∏—Å—Ç–µ–∫–ª–∞") >= 0 || StringFind(response, "expired") >= 0) {
        g_LicenseState = LICENSE_EXPIRED;
        g_LicenseMessage = "–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏ –∏—Å—Ç–µ–∫";
        Print("‚ö†Ô∏è –õ–∏—Ü–µ–Ω–∑–∏—è –∏—Å—Ç–µ–∫–ª–∞!");
        Alert("–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏ –∏—Å—Ç–µ–∫!\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∑–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º.");
        return false;
    }
    else if(StringFind(response, "–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞") >= 0 || StringFind(response, "blocked") >= 0) {
        g_LicenseState = LICENSE_BLOCKED;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º";
        Print("‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!");
        Alert("–õ–∏—Ü–µ–Ω–∑–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!");
        return false;
    }
    else if(StringFind(response, "–¥—Ä—É–≥–æ–º—É —Å—á–µ—Ç—É") >= 0 || StringFind(response, "wrong_account") >= 0) {
        g_LicenseState = LICENSE_INVALID;
        g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É —Å—á–µ—Ç—É";
        Print("‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É —Å—á–µ—Ç—É!");
        return false;
    }
    
    g_LicenseState = LICENSE_INVALID;
    g_LicenseMessage = "–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞";
    Print("‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞");
    return false;
}

//+------------------------------------------------------------------+
//| –û–¢–ü–†–ê–í–ö–ê HEARTBEAT                                               |
//+------------------------------------------------------------------+
void SendHeartbeat() {
    //--- –í –¢–ï–°–¢–ï–†–ï –ù–ï –û–¢–ü–†–ê–í–õ–Ø–ï–ú
    if(IsTestMode()) return;
    
    static datetime lastHeartbeat = 0;
    
    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª (12 –ß–ê–°–û–í)
    if(TimeCurrent() - lastHeartbeat < LICENSE_HEARTBEAT_INTERVAL) return;
    
    //--- –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º heartbeat –µ—Å–ª–∏ –ª–∏—Ü–µ–Ω–∑–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω–∞
    if(g_LicenseState != LICENSE_VALID && !g_LicenseActivated) return;
    
    lastHeartbeat = TimeCurrent();
    
    Print("üíì –û—Ç–ø—Ä–∞–≤–∫–∞ heartbeat (—Ä–∞–∑ –≤ 12 —á–∞—Å–æ–≤)...");
    
    //--- –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    string postData = "{";
    postData = postData + "\"key\":\"" + g_LicenseKey + "\",";
    postData = postData + "\"version\":\"1.6\",";
    postData = postData + "\"account\":\"" + IntegerToString(AccountNumber()) + "\",";
    postData = postData + "\"broker\":\"" + AccountCompany() + "\",";
    postData = postData + "\"balance\":\"" + DoubleToString(AccountBalance(), 2) + "\"";
    postData = postData + "}";
    
    //--- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
    SendHTTPRequest("/heartbeat", postData);
}

//+------------------------------------------------------------------+
//| –ü–†–û–í–ï–†–ö–ê –†–ê–ó–†–ï–®–ï–ù–ò–Ø –ù–ê –¢–û–†–ì–û–í–õ–Æ                                 |
//+------------------------------------------------------------------+
bool IsLicenseValidForTrading() {
    //--- –í –¢–ï–°–¢–ï–†–ï –í–°–ï–ì–î–ê –†–ê–ó–†–ï–®–ï–ù–û
    if(IsTestMode()) return true;
    
    // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ—Ä–≥–æ–≤–ª—é –µ—Å–ª–∏ –ª–∏—Ü–µ–Ω–∑–∏—è –≤–∞–ª–∏–¥–Ω–∞ –ò–õ–ò –±—ã–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –∏ –Ω–µ—Ç —Å–≤—è–∑–∏ –º–µ–Ω–µ–µ 10 –¥–Ω–µ–π
    return (g_LicenseState == LICENSE_VALID || 
            (g_LicenseActivated && g_FailedChecks < MAX_FAILED_CHECKS));
}

//+------------------------------------------------------------------+
//| –ü–û–õ–£–ß–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –õ–ò–¶–ï–ù–ó–ò–ò –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø                     |
//+------------------------------------------------------------------+
string GetLicenseStatusText() {
    //--- –í –¢–ï–°–¢–ï–†–ï
    if(IsTestMode()) {
        return "–¢–ï–°–¢–ï–†";
    }
    
    if(g_LicenseState == LICENSE_VALID) {
        if(g_FailedChecks > 0) {
            return "–ê–≤—Ç–æ–Ω–æ–º " + IntegerToString(g_FailedChecks) + "–¥";
        }
        return "–ê–∫—Ç–∏–≤–Ω–∞";
    }
    else if(g_LicenseState == LICENSE_EXPIRED) {
        return "–ò—Å—Ç–µ–∫–ª–∞";
    }
    else if(g_LicenseState == LICENSE_INVALID) {
        return "–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç.";
    }
    else if(g_LicenseState == LICENSE_BLOCKED) {
        return "–ó–∞–±–ª–æ–∫–∏—Ä.";
    }
    else if(g_LicenseState == LICENSE_NO_CONNECTION) {
        return "–ù–µ—Ç —Å–≤—è–∑–∏";
    }
    else if(g_LicenseActivated && g_FailedChecks > 0) {
        return "–ê–≤—Ç–æ–Ω–æ–º " + IntegerToString(g_FailedChecks) + "–¥";
    }
    else {
        return "–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞";
    }
}

//+------------------------------------------------------------------+
//| –ü–û–õ–£–ß–ï–ù–ò–ï –¶–í–ï–¢–ê –°–¢–ê–¢–£–°–ê                                          |
//+------------------------------------------------------------------+
color GetLicenseStatusColor() {
    //--- –í –¢–ï–°–¢–ï–†–ï
    if(IsTestMode()) {
        return C'33,150,243';  // –°–∏–Ω–∏–π –¥–ª—è —Ç–µ—Å—Ç–µ—Ä–∞
    }
    
    if(g_LicenseState == LICENSE_VALID && g_FailedChecks == 0) {
        return C'76,175,80';  // –ó–µ–ª–µ–Ω—ã–π
    }
    else if(g_FailedChecks > 0 && g_FailedChecks < 5) {
        return C'255,193,7';  // –ñ–µ–ª—Ç—ã–π - –ø–µ—Ä–≤—ã–µ 5 –¥–Ω–µ–π
    }
    else if(g_FailedChecks >= 5) {
        return C'255,152,0';  // –û—Ä–∞–Ω–∂–µ–≤—ã–π - –∫—Ä–∏—Ç–∏—á–Ω–æ
    }
    else if(g_LicenseState == LICENSE_NO_CONNECTION) {
        return C'244,67,54';  // –ö—Ä–∞—Å–Ω—ã–π
    }
    else {
        return C'244,67,54';  // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –≤—Å–µ—Ö –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö
    }
}

//+------------------------------------------------------------------+
//| –°–û–•–†–ê–ù–ò–¢–¨ –ö–õ–Æ–ß –í –§–ê–ô–õ                                           |
//+------------------------------------------------------------------+
void SaveLicenseKeyToFile(string key) {
    //--- –í –¢–ï–°–¢–ï–†–ï –ù–ï –°–û–•–†–ê–ù–Ø–ï–ú
    if(IsTestMode()) return;
    
    string filename = "FoxterAI_" + IntegerToString(AccountNumber()) + ".key";
    int handle = FileOpen(filename, FILE_WRITE | FILE_TXT | FILE_COMMON);
    
    if(handle == INVALID_HANDLE) {
        handle = FileOpen(filename, FILE_WRITE | FILE_TXT);
    }
    
    if(handle != INVALID_HANDLE) {
        FileWriteString(handle, key);
        FileClose(handle);
        Print("–ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª");
    }
}

//+------------------------------------------------------------------+
//| –ü–û–õ–£–ß–ò–¢–¨ –°–û–•–†–ê–ù–ï–ù–ù–´–ô –ö–õ–Æ–ß                                       |
//+------------------------------------------------------------------+
string GetSavedLicenseKey() {
    //--- –í –¢–ï–°–¢–ï–†–ï –í–û–ó–í–†–ê–©–ê–ï–ú –¢–ï–°–¢–û–í–´–ô –ö–õ–Æ–ß
    if(IsTestMode()) {
        return "FXAI-TEST-MODE-KEY";
    }
    
    string filename = "FoxterAI_" + IntegerToString(AccountNumber()) + ".key";
    int handle = FileOpen(filename, FILE_READ | FILE_TXT | FILE_COMMON);
    
    if(handle == INVALID_HANDLE) {
        handle = FileOpen(filename, FILE_READ | FILE_TXT);
    }
    
    if(handle != INVALID_HANDLE) {
        string key = FileReadString(handle);
        FileClose(handle);
        
        // –û—á–∏—â–∞–µ–º –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤
        string cleanKey = "";
        for(int i = 0; i < StringLen(key); i++) {
            ushort charCode = StringGetCharacter(key, i);
            if(charCode > 32) {
                cleanKey = cleanKey + CharToString((uchar)charCode);
            }
        }
        
        if(StringLen(cleanKey) == 19 && StringSubstr(cleanKey, 0, 5) == "FXAI-") {
            return cleanKey;
        }
    }
    
    return "";
}

//+------------------------------------------------------------------+
//| –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –õ–ò–¶–ï–ù–ó–ò–ò                                           |
//+------------------------------------------------------------------+
bool InitializeLicense(string licenseKey) {
    //--- –í –¢–ï–°–¢–ï–†–ï –í–°–ï–ì–î–ê –£–°–ü–ï–®–ù–û
    if(IsTestMode()) {
        g_LicenseKey = "FXAI-TEST-MODE-KEY";
        g_LicenseState = LICENSE_VALID;
        g_LicenseActivated = true;
        g_LicenseMessage = "–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º - –ª–∏—Ü–µ–Ω–∑–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è";
        
        Print("=====================================");
        Print("    –†–ï–ñ–ò–ú –¢–ï–°–¢–ï–†–ê –°–¢–†–ê–¢–ï–ì–ò–ô");
        Print("=====================================");
        Print("–õ–∏—Ü–µ–Ω–∑–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞");
        Print("=====================================");
        
        return true;
    }
    
    g_LicenseKey = licenseKey;
    
    Print("=====================================");
    Print("    –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –õ–ò–¶–ï–ù–ó–ò–ò");
    Print("=====================================");
    Print("–ö–ª—é—á: ", licenseKey);
    Print("–°—á–µ—Ç: ", AccountNumber());
    Print("–ë—Ä–æ–∫–µ—Ä: ", AccountCompany());
    Print("=====================================");
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    g_LicenseState = LICENSE_UNCHECKED;
    g_LicenseActivated = false;
    g_LastSuccessfulCheck = 0;
    g_FailedChecks = 0;
    
    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    bool result = CheckLicense(true); // true = –ø–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    
    Print("=====================================");
    Print("–†–µ–∑—É–ª—å—Ç–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ", result ? "–£–°–ü–ï–•" : "–û–®–ò–ë–ö–ê");
    if(!result) {
        Print("–ü—Ä–∏—á–∏–Ω–∞: ", g_LicenseMessage);
    } else {
        Print("–°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞");
        Print("Heartbeat –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤");
    }
    Print("=====================================");
    
    return result;
}

//+------------------------------------------------------------------+
//| –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –î–ê–ù–ù–´–• –õ–ò–¶–ï–ù–ó–ò–ò                                  |
//+------------------------------------------------------------------+
void ClearAllLicenseData() {
    //--- –í –¢–ï–°–¢–ï–†–ï –ù–ï –û–ß–ò–©–ê–ï–ú
    if(IsTestMode()) return;
    
    // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª —Å –∫–ª—é—á–æ–º
    string filename = "FoxterAI_" + IntegerToString(AccountNumber()) + ".key";
    FileDelete(filename);
    
    // –£–¥–∞–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    GlobalVariableDel("FX_LastCheck_" + IntegerToString(AccountNumber()));
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏
    g_LicenseState = LICENSE_UNCHECKED;
    g_LicenseKey = "";
    g_LicenseExpiry = 0;
    g_LastSuccessfulCheck = 0;
    g_LastCheckAttempt = 0;
    g_FailedChecks = 0;
    g_LicenseActivated = false;
    g_LicenseMessage = "";
    
    Print("‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ª–∏—Ü–µ–Ω–∑–∏–∏ –æ—á–∏—â–µ–Ω—ã");
}